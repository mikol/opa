<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="x-ua-compatible" content="ie=edge"> <title>How Do I Write Policies? | OPA</title> <meta name="description" content="OPA: An open source project to policy-enable your service."> <link type="text/css" rel="stylesheet" href="/assets/style.css"> </head> <body> <nav> <ul class="opa-nav-main--list"> <li class="opa-nav-main--home-item"> <a class="opa-nav-main--link" href="/">Open Policy Agent</a> </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/get-opa/">Get OPA</a> </li> <li class="opa-nav-main--item--selected"> Documentation </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/examples/working-with-the-opa-repl/">Examples</a> </li> <li class="opa-nav-main--item"> <a class="opa-nav-main--link" href="/community/">Community</a> </li> </ul> </nav> <header class="opa-header"> <p class="opa-header--fork-me"><a href="https://github.com/open-policy-agent/opa"><img src="/assets/github-corner-right.svg" alt="Fork me on GitHub" width="80" height="80"></a></p> <div class="opa-content"> <div class="opa-header--abstract"> <nav class="opa-header--abstract--nav"> <ul class="opa-header--abstract--nav-list"> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/what-is-policy-enablement/">What is Policy Enablement?</a> </li> <li class="opa-header--abstract--nav-item"> <a class="opa-header--abstract--nav-link" href="/documentation/how-does-opa-work/">How Does OPA Work?</a> </li> <li class="opa-header--abstract--nav-item--selected"> How Do I Write Policies? </li> </ul> </nav> <h1>How Do I Write Policies?</h1> <p>OPA is purpose built for reasoning about information represented in structured documents. The data that your service and its users publish can be inspected and transformed using OPA’s native query language Rego.</p> </div> </div> </header> <div class="opa-content"> <h2>What is Rego?</h2> <p>Rego was inspired by <a href="https://en.wikipedia.org/wiki/Datalog">Datalog</a>, which is a well understood, decades old query language. Rego extends Datalog to support structured document models such as JSON.</p> <p>Rego queries are assertions on data stored in OPA. These queries can be used to define policies that enumerate instances of data that violate the expected state of the system.</p> <h2>Why use Rego?</h2> <p>Use Rego for defining policy that is easy to read and write.</p> <p>Rego focuses on providing powerful support for referencing nested documents and ensuring that queries are correct and unambiguous.</p> <p>Rego is declarative so policy authors can focus on what queries should return rather than how queries should be executed. These queries are simpler and more concise than the equivalent in an imperative language. Like other applications which support declarative query languages, OPA is able to optimize queries to improve performance (for example, indexing, concurrent evaluation, reordering, and so on).</p> <h2>The Basics</h2> <p>This section introduces the main aspects of Rego.</p> <p>The simplest rule is a single expression and is defined in terms of a <a href="#scalar-values">Scalar Value</a>:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">pi</span> <span class="o">=</span> <span class="mi">3</span><span class="o">.</span><span class="mi">14159</span>
</code></pre> </div> <p>Rules define the content of documents. We can query for the content of the <code class="highlighter-rouge">pi</code> document generated by the rule above:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">pi</span>
<span class="mi">3</span><span class="o">.</span><span class="mi">14159</span>
</code></pre> </div> <p>Rules can also be defined in terms of <a href="#composite-values">Composite Values</a>:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">rect</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"width"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
</code></pre> </div> <p>The result:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">rect</span>
<span class="p">{</span>
  <span class="s2">"height"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="s2">"width"</span><span class="p">:</span> <span class="mi">2</span>
<span class="p">}</span>
</code></pre> </div> <p>Many expressions are defined in terms of <a href="#equality">Equality</a>. These expressions can be thought of as assertions. The simplest example of a rule containing an equality expression involves two scalar values:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">v</span> <span class="o">=</span> <span class="kp">true</span> <span class="p">:</span><span class="o">-</span> <span class="mi">42</span> <span class="o">=</span> <span class="s2">"the meaning of life"</span>
</code></pre> </div> <p>We can evaluate <code class="highlighter-rouge">v</code> to check if it is equal to true:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">v</span> <span class="o">=</span> <span class="kp">true</span>
<span class="kp">false</span>
</code></pre> </div> <p>The order of operands in an equality expression does not matter. The result is the same:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="kp">true</span> <span class="o">=</span> <span class="n">v</span>
<span class="kp">false</span>
</code></pre> </div> <p>If we evaluate <code class="highlighter-rouge">v</code> on its own, the REPL prints <code class="highlighter-rouge">undefined</code> because the body of the rule never evaluates to <code class="highlighter-rouge">true</code>. As a result, the document generated by the rule is not defined.</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">v</span>
<span class="n">undefined</span>
</code></pre> </div> <p>We can define rules in terms of <a href="#variables">Variables</a> as well:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">t</span> <span class="p">:</span><span class="o">-</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">41</span><span class="p">,</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span>
</code></pre> </div> <p>Multiple expressions are separated by the comma (<code class="highlighter-rouge">,</code>) character. In order for the rule to be true, all of the expressions in the rule must true for some set of variable bindings. There may be multiple sets of variable bindings that make the rule true. The body of a rule can be understood intuitively as <code class="highlighter-rouge">&lt;expression-1&gt; AND &lt;expression-2&gt; AND ... AND &lt;expression-N&gt;</code>. The rule itself can be understood intuitively as <code class="highlighter-rouge">&lt;rule-name&gt;</code> is <code class="highlighter-rouge">true</code> if <code class="highlighter-rouge">&lt;body&gt;</code>.</p> <p>When we query for the contents of <code class="highlighter-rouge">t</code> we see the obvious result:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">t</span>
<span class="kp">true</span>
</code></pre> </div> <p>The order of expressions in a rule does not affect the document’s content:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">s</span> <span class="p">:</span><span class="o">-</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">41</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">42</span>
</code></pre> </div> <p>The query result is the same:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">s</span>
<span class="kp">true</span>
</code></pre> </div> <p>Rego <a href="#references">References</a> help you refer to nested documents. For example:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">sites</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"prod"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"smoke1"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"dev"</span><span class="p">}]</span>

<span class="n">r</span> <span class="p">:</span><span class="o">-</span> <span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"prod"</span>
</code></pre> </div> <p>The rule <code class="highlighter-rouge">r</code> above asserts that there exists (at least) one document within <code class="highlighter-rouge">sites</code> where the <code class="highlighter-rouge">name</code> attribute equals <code class="highlighter-rouge">"prod"</code>.</p> <p>The result:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">r</span>
<span class="kp">true</span>
</code></pre> </div> <p>We can generalize the example above with a rule that defines a set document instead of a boolean document:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">q</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span> <span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span>
</code></pre> </div> <p>When we query for <code class="highlighter-rouge">q</code> we obtain a set of names:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
<span class="o">+----------+</span>
<span class="o">|</span>    <span class="n">x</span>     <span class="o">|</span>
<span class="o">+----------+</span>
<span class="o">|</span> <span class="s2">"prod"</span>   <span class="o">|</span>
<span class="o">|</span> <span class="s2">"smoke1"</span> <span class="o">|</span>
<span class="o">|</span> <span class="s2">"dev"</span>    <span class="o">|</span>
<span class="o">+----------+</span>
</code></pre> </div> <p>We can re-write the rule <code class="highlighter-rouge">r</code> from above to make use of <code class="highlighter-rouge">q</code>. We will call the new rule <code class="highlighter-rouge">p</code>:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">p</span> <span class="p">:</span><span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="s2">"prod"</span><span class="p">]</span>
</code></pre> </div> <p>The result will be the same:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">p</span>
<span class="kp">true</span>
</code></pre> </div> <p>Rules which have arguments can be queried with input values:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="s2">"smoke2"</span><span class="p">]</span>
<span class="n">undefined</span>
<span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="s2">"dev"</span><span class="p">]</span>
<span class="kp">true</span>
</code></pre> </div> <p>If you made it this far, congratulations. This section introduced the main aspects of Rego. The rest of this document describes the individual aspects of Rego in detail and is useful as a reference when reading and writing policy. Rego’s syntax is defined at the end of this document in the <a href="#grammar">Rego Grammar</a> section.</p> <h2><a name="scalar-values"></a> Scalar Values</h2> <p>Scalar values are the simplest type of term in Rego. Scalar values can be strings, numbers, booleans, or null.</p> <p>Documents can be defined solely in terms of scalar values. This is useful for defining constants that are referenced in multiple places. For example:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">greeting</span>   <span class="o">=</span> <span class="s2">"Hello"</span>
<span class="n">max_height</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">pi</span>         <span class="o">=</span> <span class="mi">3</span><span class="o">.</span><span class="mi">14159</span>
<span class="n">allowed</span>    <span class="o">=</span> <span class="kp">true</span>
<span class="n">sentinel</span>   <span class="o">=</span> <span class="n">null</span>
</code></pre> </div> <p>These documents can be queried like any other:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">greeting</span>
<span class="s2">"Hello"</span>
<span class="o">&gt;</span> <span class="n">max_height</span>
<span class="mi">42</span>
<span class="o">&gt;</span> <span class="n">pi</span>
<span class="mi">3</span><span class="o">.</span><span class="mi">14159</span>
<span class="o">&gt;</span> <span class="n">allowed</span>
<span class="kp">true</span>
<span class="o">&gt;</span> <span class="n">sentinel</span>
<span class="n">null</span>
</code></pre> </div> <h2><a name="composite-values"></a> Composite Values</h2> <p>Composite values define collections. In simple cases, composite values can be treated as constants like <a href="#scalar-values">Scalar Values</a>:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">cube</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"width"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"height"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">"depth"</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
</code></pre> </div> <p>The result:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">cube</span><span class="p">.</span><span class="nf">width</span>
<span class="mi">3</span>
</code></pre> </div> <p>Composite values can also be defined in terms of <a href="#variables">Variables</a> or <a href="#references">References</a>. For example:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="kp">false</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">null</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"a"</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s2">"x"</span><span class="p">:</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">]}</span>
<span class="o">+----+-------+------+---------------------------+</span>
<span class="o">|</span> <span class="no">A</span>  <span class="o">|</span>   <span class="no">B</span>   <span class="o">|</span>  <span class="no">C</span>   <span class="o">|</span>             <span class="no">D</span>             <span class="o">|</span>
<span class="o">+----+-------+------+---------------------------+</span>
<span class="o">|</span> <span class="mi">42</span> <span class="o">|</span> <span class="kp">false</span> <span class="o">|</span> <span class="n">null</span> <span class="o">|</span> <span class="p">{</span><span class="s2">"a"</span><span class="p">:</span><span class="mi">42</span><span class="p">,</span><span class="s2">"x"</span><span class="p">:[</span><span class="kp">false</span><span class="p">,</span><span class="n">null</span><span class="p">]}</span> <span class="o">|</span>
<span class="o">+----+-------+------+---------------------------+</span>
</code></pre> </div> <p>By defining composite values in terms of variables and references, rules can define abstractions over raw data and other rules.</p> <h2><a name="variables"></a> Variables</h2> <p>Variables are another kind of term in Rego. They appear in both the head and body of rules.</p> <p>Variables appearing in the head of a rule can be thought of as input and output of the rule. Unlike many programming languages, where a variable is either an input or an output, in Rego a variable is simultaneously an input and an output. If a query supplies a value for a variable, that variable is an input, and if the query does not supply a value for a variable, that variable is an output.</p> <p>For example:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">sites</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"prod"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"smoke1"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"dev"</span><span class="p">}]</span> <span class="p">:</span><span class="o">-</span> <span class="kp">true</span>

<span class="n">q</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span> <span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span>
</code></pre> </div> <p>In this case, we evaluate <code class="highlighter-rouge">q</code> with a variable <code class="highlighter-rouge">x</code> (which is not bound to a value). As as result, the query returns all of the site names.</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
<span class="o">+----------+</span>
<span class="o">|</span>    <span class="n">x</span>     <span class="o">|</span>
<span class="o">+----------+</span>
<span class="o">|</span> <span class="s2">"prod"</span>   <span class="o">|</span>
<span class="o">|</span> <span class="s2">"smoke1"</span> <span class="o">|</span>
<span class="o">|</span> <span class="s2">"dev"</span>    <span class="o">|</span>
<span class="o">+----------+</span>
</code></pre> </div> <p>On the other hand, if we evaluate <code class="highlighter-rouge">q</code> with an input value for <code class="highlighter-rouge">name</code> we can determine whether <code class="highlighter-rouge">name</code> exists in the document defined by <code class="highlighter-rouge">q</code>:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="s2">"smoke2"</span><span class="p">]</span>
<span class="n">undefined</span>
<span class="o">&gt;</span> <span class="n">q</span><span class="p">[</span><span class="s2">"dev"</span><span class="p">]</span>
<span class="kp">true</span>
</code></pre> </div> <p>Variables appearing in the head of a rule must also appear in a non-negated equality expression within the same rule. This property ensures that if the rule is evaluated and all of the expressions evaluate to true for some set of variable bindings, the variable in the head of the rule will be defined.</p> <h2><a name="references"></a> References</h2> <p>Referenced are used to access nested documents.</p> <p>The examples in this section use the data defined in the <a href="#examples">Examples</a> section.</p> <p>The simplest reference contains no variables. For example, the following reference returns the hostname of the second server in the first site document from our example data:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">hostname</span>
<span class="s2">"helium"</span>
</code></pre> </div> <p>References are typically written using the “dot-access” style. The canonical form does away with <code class="highlighter-rouge">.</code> and closely resembles dictionary lookup in a language such as Python:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"servers"</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"hostname"</span><span class="p">]</span>
<span class="s2">"helium"</span>
</code></pre> </div> <p>Both forms are valid, however, the dot-access style is typically more readable. Note that there are two cases where brackets must be used:</p> <ol> <li>String keys containing characters other than <code class="highlighter-rouge">[a-z]</code>, <code class="highlighter-rouge">[A-Z]</code>, <code class="highlighter-rouge">[0-9]</code>, or <code class="highlighter-rouge">_</code> (underscore).</li> <li>Non-string keys such as numbers, booleans, and null.</li> <li>Variable keys which are described later.</li> </ol> <p>References are always prefixed with a variable that identifies the root document. In the example above this is <code class="highlighter-rouge">p</code>. The root document may be:</p> <ul> <li>a local variable inside a rule.</li> <li>a rule inside the same package.</li> <li>a document stored in OPA.</li> <li>a documented temporarily provided to OPA as part of a transaction.</li> </ul> <h3>Variable Keys</h3> <p>References can include variables as keys. References written this way are used to select a value from every element in a collection.</p> <p>The following reference will select the hostnames of all the servers in our example data:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="nf">hostname</span>
<span class="o">+---+---+------------------------------+</span>
<span class="o">|</span> <span class="n">i</span> <span class="o">|</span> <span class="n">j</span> <span class="o">|</span> <span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="nf">hostname</span> <span class="o">|</span>
<span class="o">+---+---+------------------------------+</span>
<span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="s2">"hydrogen"</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="s2">"helium"</span>                     <span class="o">|</span>
<span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="s2">"lithium"</span>                    <span class="o">|</span>
<span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="s2">"beryllium"</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="s2">"boron"</span>                      <span class="o">|</span>
<span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="s2">"carbon"</span>                     <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="s2">"nitrogen"</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="s2">"oxygen"</span>                     <span class="o">|</span>
<span class="o">+---+---+------------------------------+</span>
</code></pre> </div> <p>Conceptually, this is the same as the following imperative (Python) code:</p> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">hostnames</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre> </div> <p>In the reference above, we effectively used variables named <code class="highlighter-rouge">i</code> and <code class="highlighter-rouge">j</code> to iterate the collections. If the variables are unused outside the reference, we prefer to replace them with an underscore (<code class="highlighter-rouge">_</code>) character. The reference above can be rewritten as:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">sites</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">hostname</span>
<span class="o">+------------------------------+</span>
<span class="o">|</span> <span class="n">sites</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">hostname</span> <span class="o">|</span>
<span class="o">+------------------------------+</span>
<span class="o">|</span> <span class="s2">"hydrogen"</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="s2">"helium"</span>                     <span class="o">|</span>
<span class="o">|</span> <span class="s2">"lithium"</span>                    <span class="o">|</span>
<span class="o">|</span> <span class="s2">"beryllium"</span>                  <span class="o">|</span>
<span class="o">|</span> <span class="s2">"boron"</span>                      <span class="o">|</span>
<span class="o">|</span> <span class="s2">"carbon"</span>                     <span class="o">|</span>
<span class="o">|</span> <span class="s2">"nitrogen"</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="s2">"oxygen"</span>                     <span class="o">|</span>
<span class="o">+------------------------------+</span>
</code></pre> </div> <p>The underscore is special because it cannot be referred to by other parts of the rule, e.g., the other side of the expression, another expression, etc. The underscore can be thought of as a special iterator. Each time an underscore is specified, a new iterator is instantiated.</p> <blockquote class="opa-tip"> <p>Under the hood, OPA translates the <code class="highlighter-rouge">_</code> character to a unique variable name that does not conflict with variables and rules that are in scope.</p> </blockquote> <h3>Multiple Expressions</h3> <p>Rules are often written in terms of multiple expressions that contain references to documents. In the following example, the rule defines a set of arrays where each array contains an application name and a hostname of a server where the application is deployed.</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">apps_and_hostnames</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span>
    <span class="n">apps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span><span class="p">,</span>
    <span class="n">apps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
    <span class="n">sites</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
    <span class="n">sites</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="nf">hostname</span> <span class="o">=</span> <span class="n">hostname</span><span class="p">,</span>
    <span class="n">pair</span> <span class="o">=</span> <span class="p">[</span><span class="nb">name</span><span class="p">,</span> <span class="n">hostname</span><span class="p">]</span>
</code></pre> </div> <p>The result:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">apps_and_hostnames</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
<span class="o">+----------------------+</span>
<span class="o">|</span>          <span class="n">x</span>           <span class="o">|</span>
<span class="o">+----------------------+</span>
<span class="o">|</span> <span class="p">[</span><span class="s2">"web"</span><span class="p">,</span><span class="s2">"hydrogen"</span><span class="p">]</span>   <span class="o">|</span>
<span class="o">|</span> <span class="p">[</span><span class="s2">"web"</span><span class="p">,</span><span class="s2">"helium"</span><span class="p">]</span>     <span class="o">|</span>
<span class="o">|</span> <span class="p">[</span><span class="s2">"web"</span><span class="p">,</span><span class="s2">"beryllium"</span><span class="p">]</span>  <span class="o">|</span>
<span class="o">|</span> <span class="p">[</span><span class="s2">"web"</span><span class="p">,</span><span class="s2">"boron"</span><span class="p">]</span>      <span class="o">|</span>
<span class="o">|</span> <span class="p">[</span><span class="s2">"web"</span><span class="p">,</span><span class="s2">"nitrogen"</span><span class="p">]</span>   <span class="o">|</span>
<span class="o">|</span> <span class="p">[</span><span class="s2">"mysql"</span><span class="p">,</span><span class="s2">"lithium"</span><span class="p">]</span>  <span class="o">|</span>
<span class="o">|</span> <span class="p">[</span><span class="s2">"mysql"</span><span class="p">,</span><span class="s2">"carbon"</span><span class="p">]</span>   <span class="o">|</span>
<span class="o">|</span> <span class="p">[</span><span class="s2">"mongodb"</span><span class="p">,</span><span class="s2">"oxygen"</span><span class="p">]</span> <span class="o">|</span>
<span class="o">+----------------------+</span>
</code></pre> </div> <p>Don’t worry about understanding everything in this example right now. There are just two important points:</p> <ol> <li>Several variables appear more than once in the body. When a variable is used in multiple locations, OPA will only produce documents for the rule with the variable bound to the same value in all expressions.</li> <li>The rule is joining the <code class="highlighter-rouge">apps</code> and <code class="highlighter-rouge">sites</code> documents implicitly. In Rego (and other languages based on Datalog), joins are implicit.</li> </ol> <h3>Self-Joins</h3> <p>Using a different key on the same array or object provides the equivalent of self-join in SQL. For example, the following rule defines a document containing apps deployed on the same site as <code class="highlighter-rouge">"mysql"</code>:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">same_site</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span>
    <span class="n">apps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"mysql"</span><span class="p">,</span>
    <span class="n">apps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
    <span class="n">sites</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
    <span class="n">sites</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="n">other_server</span><span class="p">,</span>
    <span class="n">server</span> <span class="o">!=</span> <span class="n">other_server</span><span class="p">,</span>
    <span class="n">apps</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_server</span><span class="p">,</span>
    <span class="n">apps</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span>
</code></pre> </div> <p>The result:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">same_site</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
<span class="o">+-------+</span>
<span class="o">|</span>   <span class="n">x</span>   <span class="o">|</span>
<span class="o">+-------+</span>
<span class="o">|</span> <span class="s2">"web"</span> <span class="o">|</span>
<span class="o">|</span> <span class="s2">"web"</span> <span class="o">|</span>
<span class="o">|</span> <span class="s2">"web"</span> <span class="o">|</span>
<span class="o">|</span> <span class="s2">"web"</span> <span class="o">|</span>
<span class="o">+-------+</span>
</code></pre> </div> <h2><a name="comprehensions"></a> Comprehensions</h2> <p>Comprehensions provide a concise way of building <a href="#composite-values">Composite Values</a> from sub-queries.</p> <p>Like <a href="#rules">Rules</a>, comprehensions consist of a head and a body. The body of a comprehension can be understood in exactly the same way as the body of a rule, that is, one or more expressions that must all be true in order for the overall body to be true. When the body evaluates to true, the head of the comprehension is evaluated to produce an element in the result.</p> <p>The body of a comprehension is able to refer to variables defined in the outer body. For example:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">region</span> <span class="o">=</span> <span class="s2">"west"</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">name</span> <span class="o">|</span> <span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">region</span> <span class="o">=</span> <span class="n">region</span><span class="p">,</span> <span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span><span class="p">]</span>
<span class="o">+-----------------+--------+</span>
<span class="o">|</span>      <span class="n">names</span>      <span class="o">|</span> <span class="n">region</span> <span class="o">|</span>
<span class="o">+-----------------+--------+</span>
<span class="o">|</span> <span class="p">[</span><span class="s2">"smoke"</span><span class="p">,</span><span class="s2">"dev"</span><span class="p">]</span> <span class="o">|</span> <span class="s2">"west"</span> <span class="o">|</span>
<span class="o">+-----------------+--------+</span>
</code></pre> </div> <p>In the above query, the second expression contains an <a href="#array-comprehension">Array Comprehension</a> that refers to the <code class="highlighter-rouge">region</code> variable. The region variable will be bound in the outer body.</p> <blockquote class="opa-tip"> <p>When a comprehension refers to a variable in an outer body, OPA will reorder expressions in the outer body so that variables referred to in the comprehension are bound by the time the comprehension is evaluated.</p> </blockquote> <p>Comprehensions are similar to the same constructs found in other languages like Python. For example, we could write the above comprehension in Python as follows:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># Python equivalent of Rego comprehension shown above.</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">site</span><span class="p">.</span><span class="nf">name</span> <span class="k">for</span> <span class="n">site</span> <span class="k">in</span> <span class="n">sites</span> <span class="k">if</span> <span class="n">site</span><span class="p">.</span><span class="nf">region</span> <span class="o">=</span> <span class="s2">"west"</span><span class="p">]</span>
</code></pre> </div> <p>Comprehensions are often used to group elements by some key. A common use case for comprehensions is to assist in computing aggregate values (e.g., the number of containers running on a host).</p> <h3><a name="array-comprehension"></a> Array Comprehensions</h3> <p>Array Comprehensions build array values out of sub-queries. Array Comprehensions have the form:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="p">[</span> <span class="o">&lt;</span><span class="n">term</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span> <span class="p">]</span>
</code></pre> </div> <p>For example, the following rule defines an object where the keys are application names and the values are hostnames of servers where the application is deployed. The hostnames of servers are represented as an array.</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">app_to_hostnames</span><span class="p">[</span><span class="n">app_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hostnames</span> <span class="p">:</span><span class="o">-</span>
    <span class="n">apps</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">,</span>
    <span class="n">app_name</span> <span class="o">=</span> <span class="n">app</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
    <span class="n">hostnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">hostname</span> <span class="o">|</span> <span class="nb">name</span> <span class="o">=</span> <span class="n">app</span><span class="p">.</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">],</span>
                            <span class="n">sites</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span>
                            <span class="n">s</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span><span class="p">,</span>
                            <span class="n">hostname</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">hostname</span><span class="p">]</span>
</code></pre> </div> <p>The result:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">app_to_hostnames</span><span class="p">[</span><span class="n">app</span><span class="p">]</span> <span class="o">=</span> <span class="n">hostnames</span>
<span class="o">+-----------+------------------------------------------------------+</span>
<span class="o">|</span>    <span class="n">app</span>    <span class="o">|</span>                      <span class="n">hostnames</span>                       <span class="o">|</span>
<span class="o">+-----------+------------------------------------------------------+</span>
<span class="o">|</span> <span class="s2">"web"</span>     <span class="o">|</span> <span class="p">[</span><span class="s2">"hydrogen"</span><span class="p">,</span><span class="s2">"helium"</span><span class="p">,</span><span class="s2">"beryllium"</span><span class="p">,</span><span class="s2">"boron"</span><span class="p">,</span><span class="s2">"nitrogen"</span><span class="p">]</span> <span class="o">|</span>
<span class="o">|</span> <span class="s2">"mysql"</span>   <span class="o">|</span> <span class="p">[</span><span class="s2">"lithium"</span><span class="p">,</span><span class="s2">"carbon"</span><span class="p">]</span>                                 <span class="o">|</span>
<span class="o">|</span> <span class="s2">"mongodb"</span> <span class="o">|</span> <span class="p">[</span><span class="s2">"oxygen"</span><span class="p">]</span>                                           <span class="o">|</span>
<span class="o">+-----------+------------------------------------------------------+</span>
</code></pre> </div> <p>In the future, Rego will support Set and Object comprehensions.</p> <h2><a name="rules"></a> Rules</h2> <p>Rules define the content of <a href="/docs/arch.html#data-model">virtual documents</a> in OPA. When OPA evaluates a rule, we say OPA <em>generates</em> the content of the document that is defined by the rule.</p> <p>The sample code in this section make use of the data defined in <a href="#examples">Examples</a>.</p> <h3><a name="set-documents"></a> Generating Sets</h3> <p>The following rule documents a set containing the hostnames of all servers:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">hostnames</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span> <span class="n">sites</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">hostname</span> <span class="o">=</span> <span class="nb">name</span>
</code></pre> </div> <p>When we query for the content of <code class="highlighter-rouge">hostnames</code> we see the same data as we would if we queried using the <code class="highlighter-rouge">sites[_].servers[_].hostname</code> reference directly:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">hostnames</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span>
<span class="o">+-------------+</span>
<span class="o">|</span>    <span class="nb">name</span>     <span class="o">|</span>
<span class="o">+-------------+</span>
<span class="o">|</span> <span class="s2">"hydrogen"</span>  <span class="o">|</span>
<span class="o">|</span> <span class="s2">"helium"</span>    <span class="o">|</span>
<span class="o">|</span> <span class="s2">"lithium"</span>   <span class="o">|</span>
<span class="o">|</span> <span class="s2">"beryllium"</span> <span class="o">|</span>
<span class="o">|</span> <span class="s2">"boron"</span>     <span class="o">|</span>
<span class="o">|</span> <span class="s2">"carbon"</span>    <span class="o">|</span>
<span class="o">|</span> <span class="s2">"nitrogen"</span>  <span class="o">|</span>
<span class="o">|</span> <span class="s2">"oxygen"</span>    <span class="o">|</span>
<span class="o">+-------------+</span>
</code></pre> </div> <p>This example introduces a few important aspects of Rego.</p> <p>First, the rule defines a set document where the contents are defined by the variable <code class="highlighter-rouge">name</code>. We know this rule defines a set document because the head only includes a key. All rules have the following form (where key, value, and body are all optional):</p> <div class="highlighter-rouge"><pre class="highlight"><code>&lt;name&gt; &lt;key&gt;? &lt;value&gt;? &lt;body&gt;?
</code></pre> </div> <p>For a more formal definition of the rule syntax, see the <a href="#grammar">Rego Grammar</a> section at the end of this document.</p> <blockquote class="opa-tip"> <p>Set documents are collections of values without keys. OPA represents set documents as arrays when serializing to JSON or other formats which do not support a set data type. The important distinction between sets and arrays or objects is that sets are unkeyed while arrays and objects are keyed, i.e., you cannot refer to the index of an element within a set.</p> </blockquote> <p>Second, the <code class="highlighter-rouge">sites[_].servers[_].hostname</code> fragment selects the <code class="highlighter-rouge">hostname</code> attribute from all of the objects in the <code class="highlighter-rouge">servers</code> collection. From reading the fragment in isolation we cannot tell whether the fragment refers to arrays or objects. We only know that it refers to a collections of values.</p> <p>Third, the <code class="highlighter-rouge">sites[_].servers[_].hostname = name</code> expression binds the value of the <code class="highlighter-rouge">hostname</code> attribute to the variable <code class="highlighter-rouge">name</code>, which is also declared in the head of the rule.</p> <h3><a name="object-documents"></a> Generating Objects</h3> <p>Rules that define objects are very similar to rules that define sets.</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">apps_by_hostname</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span> <span class="p">:</span><span class="o">-</span>
    <span class="n">sites</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
    <span class="n">server</span><span class="p">.</span><span class="nf">hostname</span> <span class="o">=</span> <span class="n">hostname</span><span class="p">,</span>
    <span class="n">apps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
    <span class="n">apps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="n">app</span>
</code></pre> </div> <p>The rule above defines an object that maps hostnames to app names. The main difference between this rule and one which defines a set is the rule head: in addition to declaring a value, the rule head also declares a key for the document.</p> <p>The result:</p> <div class="highlighter-rouge"><pre class="highlight"><code>&gt; apps_by_hostname["helium"] = app
+-------+
|  app  |
+-------+
| "web" |
+-------+
</code></pre> </div> <h3><a name="incremental-definitions"></a> Incremental Definitions</h3> <p>A rule may be defined multiple times with the same name. When a rule is defined this way, we refer to the rule definition as <em>incremental</em> because each definition is additive. The document content for an incrementally defined rule is the union of the document content for each of the individual rules.</p> <p>For example, we can write a rule that abstracts over our <code class="highlighter-rouge">servers</code> and <code class="highlighter-rouge">containers</code> data as <code class="highlighter-rouge">instances</code>:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">instances</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span>
    <span class="n">sites</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"address"</span><span class="p">:</span> <span class="n">server</span><span class="p">.</span><span class="nf">hostname</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="n">server</span><span class="p">.</span><span class="nf">name</span><span class="p">}</span>

<span class="n">instances</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span>
    <span class="n">containers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">container</span><span class="p">,</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"address"</span><span class="p">:</span> <span class="n">container</span><span class="p">.</span><span class="nf">ipaddress</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="n">container</span><span class="p">.</span><span class="nf">name</span><span class="p">}</span>
</code></pre> </div> <p>An incrementally defined rule can be intuitively understood as <code class="highlighter-rouge">&lt;rule-1&gt; OR &lt;rule-2&gt; OR ... OR &lt;rule-N&gt;</code>.</p> <p>The result:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">instances</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
<span class="o">+-----------------------------------------------+</span>
<span class="o">|</span>                       <span class="n">x</span>                       <span class="o">|</span>
<span class="o">+-----------------------------------------------+</span>
<span class="o">|</span> <span class="p">{</span><span class="s2">"address"</span><span class="ss">:"hydrogen"</span><span class="p">,</span><span class="s2">"name"</span><span class="ss">:"web-0"</span><span class="p">}</span>         <span class="o">|</span>
<span class="o">|</span> <span class="p">{</span><span class="s2">"address"</span><span class="ss">:"helium"</span><span class="p">,</span><span class="s2">"name"</span><span class="ss">:"web-1"</span><span class="p">}</span>           <span class="o">|</span>
<span class="o">|</span> <span class="p">{</span><span class="s2">"address"</span><span class="ss">:"lithium"</span><span class="p">,</span><span class="s2">"name"</span><span class="ss">:"db-0"</span><span class="p">}</span>           <span class="o">|</span>
<span class="o">|</span> <span class="p">{</span><span class="s2">"address"</span><span class="ss">:"beryllium"</span><span class="p">,</span><span class="s2">"name"</span><span class="ss">:"web-1000"</span><span class="p">}</span>     <span class="o">|</span>
<span class="o">|</span> <span class="p">{</span><span class="s2">"address"</span><span class="ss">:"boron"</span><span class="p">,</span><span class="s2">"name"</span><span class="ss">:"web-1001"</span><span class="p">}</span>         <span class="o">|</span>
<span class="o">|</span> <span class="p">{</span><span class="s2">"address"</span><span class="ss">:"carbon"</span><span class="p">,</span><span class="s2">"name"</span><span class="ss">:"db-1000"</span><span class="p">}</span>         <span class="o">|</span>
<span class="o">|</span> <span class="p">{</span><span class="s2">"address"</span><span class="ss">:"nitrogen"</span><span class="p">,</span><span class="s2">"name"</span><span class="ss">:"web-dev"</span><span class="p">}</span>       <span class="o">|</span>
<span class="o">|</span> <span class="p">{</span><span class="s2">"address"</span><span class="ss">:"oxygen"</span><span class="p">,</span><span class="s2">"name"</span><span class="ss">:"db-dev"</span><span class="p">}</span>          <span class="o">|</span>
<span class="o">|</span> <span class="p">{</span><span class="s2">"address"</span><span class="ss">:"10.0.0.1"</span><span class="p">,</span><span class="s2">"name"</span><span class="ss">:"big_stallman"</span><span class="p">}</span>  <span class="o">|</span>
<span class="o">|</span> <span class="p">{</span><span class="s2">"address"</span><span class="ss">:"10.0.0.2"</span><span class="p">,</span><span class="s2">"name"</span><span class="ss">:"cranky_euclid"</span><span class="p">}</span> <span class="o">|</span>
<span class="o">+-----------------------------------------------+</span>
</code></pre> </div> <h2><a name="negation"></a> Negation</h2> <p>To generate the content of a <a href="/docs/arch.html#data-model">Virtual Document</a>, OPA attempts to bind variables in the body of the rule such that all expressions in the rule evaluate to True.</p> <p>This generates the correct result when the expressions represent assertions about what states should exist in the data stored in OPA. In some cases, you want to express that certain states <em>should not</em> exist in the data stored in OPA. In these cases, negation must be used.</p> <p>For safety, a variable appearing in a negated expression must also appear in another non-negated equality expression in the rule.</p> <blockquote class="opa-tip"> <p>OPA will reorder expressions to ensure that negated expressions are evaluated after other non-negated expressions with the same variables. OPA will reject rules containing negated expressions that do not meet the safety criteria described above.</p> </blockquote> <p>The simplest use of negation involves only scalar values or variables and is equivalent to complementing the operator:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">t</span> <span class="p">:</span><span class="o">-</span> <span class="mi">42</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">not</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">"the meaning of life"</span>
</code></pre> </div> <p>The result:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">t</span>
<span class="kp">true</span>
</code></pre> </div> <p>Negation is required to check whether some value <em>does not</em> exist in a collection. That is, complementing the operator in an expression such as <code class="highlighter-rouge">p[_] = "foo"</code> yields <code class="highlighter-rouge">p[_] != "foo"</code>. However, this is not equivalent to <code class="highlighter-rouge">not p["foo"]</code>.</p> <p>For example, we can write a rule that defines a document containing names of apps not deployed on the <code class="highlighter-rouge">"prod"</code> site:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">prod_servers</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span>
    <span class="n">sites</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">site</span><span class="p">,</span>
    <span class="n">site</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"prod"</span><span class="p">,</span>
    <span class="n">site</span><span class="p">.</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span>

<span class="n">apps_in_prod</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span>
    <span class="n">apps</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="p">,</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">servers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">server</span><span class="p">,</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span><span class="p">,</span>
    <span class="n">prod_servers</span><span class="p">[</span><span class="n">server</span><span class="p">]</span>

<span class="n">apps_not_in_prod</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span>
    <span class="n">apps</span><span class="p">[</span><span class="n">_</span><span class="p">].</span><span class="nf">name</span> <span class="o">=</span> <span class="nb">name</span><span class="p">,</span>
    <span class="n">not</span> <span class="n">apps_in_prod</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span>
</code></pre> </div> <p>The result:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">apps_not_in_prod</span><span class="p">[</span><span class="nb">name</span><span class="p">]</span>
<span class="o">+-----------+</span>
<span class="o">|</span>   <span class="nb">name</span>    <span class="o">|</span>
<span class="o">+-----------+</span>
<span class="o">|</span> <span class="s2">"mongodb"</span> <span class="o">|</span>
<span class="o">+-----------+</span>
</code></pre> </div> <h2><a name="modules"></a> Modules</h2> <p>In Rego, policies are defined inside <em>modules</em>. Modules consist of:</p> <ul> <li>Exactly one <a href="#packages">Package</a> declaration.</li> <li>Zero or more <a href="#imports">Import</a> statements.</li> <li>Zero or more <a href="#rules">Rule</a> definitions.</li> </ul> <p>Modules are typically represented in Unicode text and encoded in UTF-8.</p> <h3><a name="comments"></a> Comments</h3> <p>Comments begin with the <code class="highlighter-rouge">#</code> character and continue until the end of the line.</p> <h3><a name="packages"></a> Packages</h3> <p>Packages group the rules defined in one or more modules into a particular namespace. Because rules are namespaced they can be safely shared across projects.</p> <p>Modules contributing to the same package do not have to be located in the same directory.</p> <p>The rules defined in a module are automatically exported. That is, they can be queried under OPA’s <a href="/docs/arch.html#data-api">Data API</a> provided the appropriate package is given. For example, given the following module:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">package</span> <span class="n">opa</span><span class="p">.</span><span class="nf">examples</span>

<span class="n">pi</span> <span class="o">=</span> <span class="mi">3</span><span class="o">.</span><span class="mi">14159</span>
</code></pre> </div> <p>The <code class="highlighter-rouge">pi</code> document can be queried via the Data API:</p> <div class="language-http highlighter-rouge"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">https://example.com/v1/data/opa/examples/pi</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre> </div> <h3><a name="imports"></a> Imports</h3> <p>Import statements declare dependencies that modules have on documents defined outside the package. By importing a document, the identifiers exported by that document can be referenced within the current module.</p> <p>All modules contain an implicit statement which imports the <code class="highlighter-rouge">data</code> document.</p> <p>Modules use the same syntax to declare dependencies on <a href="/docs/arch.html#data-model">Base Documents and Virtual Documents</a>.</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">package</span> <span class="n">opa</span><span class="p">.</span><span class="nf">examples</span>

<span class="n">import</span> <span class="n">data</span><span class="p">.</span><span class="nf">servers</span>

<span class="n">http_servers</span><span class="p">[</span><span class="n">server</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span>
    <span class="n">server</span><span class="p">.</span><span class="nf">protocols</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"http"</span>
</code></pre> </div> <p>Imports can include an optional <code class="highlighter-rouge">alias</code> statement to handle namespacing issues:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">package</span> <span class="n">opa</span><span class="p">.</span><span class="nf">examples</span>

<span class="n">import</span> <span class="n">data</span><span class="p">.</span><span class="nf">servers</span> <span class="n">as</span> <span class="n">my_servers</span>

<span class="n">http_servers</span><span class="p">[</span><span class="n">server</span><span class="p">]</span> <span class="p">:</span><span class="o">-</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">my_servers</span><span class="p">[</span><span class="n">_</span><span class="p">]</span>
    <span class="n">server</span><span class="p">.</span><span class="nf">protocols</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"http"</span>
</code></pre> </div> <h2><a name="operators"></a> Operators</h2> <h3><a name="equality"></a> Equality</h3> <p>The equality operator (<code class="highlighter-rouge">=</code>) is used to define expressions that assert that two values are the same. If the expression is defined in terms of one or more variables then the expression will evaluate to true if one of the variables is unbound. If the neither operand is an unbound variable, the expression is evaluated by comparing the <em>values</em> referenced by the operands.</p> <p>OPA attempts to <em>bind</em> variables to values when it encounters unbound variables in equality expressions. Binding a variable affects subsequent evaluation of expressions such that the variable will be treated as a constant (with the bound value) instead of a variable.</p> <h3><a name="inequality"></a> Inequality</h3> <p>The following inequality operators are supported:</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">a</span>  <span class="o">!=</span>  <span class="n">b</span>  <span class="c1">#  `a` is not equal to `b`.</span>
<span class="n">a</span>  <span class="o">&lt;</span>   <span class="n">b</span>  <span class="c1">#  `a` is less than `b`.</span>
<span class="n">a</span>  <span class="o">&lt;=</span>  <span class="n">b</span>  <span class="c1">#  `a` is less than or equal to `b`.</span>
<span class="n">a</span>  <span class="o">&gt;</span>   <span class="n">b</span>  <span class="c1">#  `a` is greater than `b`.</span>
<span class="n">a</span>  <span class="o">&gt;=</span>  <span class="n">b</span>  <span class="c1">#  `a` is greater than or equal to `b`.</span>
</code></pre> </div> <p>Unlike the equality operator, these operators do not bind variables contained in the expression. As a result, if either operand is a variable, the variable must appear in another expression in the same rule that would cause the variable to be bound, i.e., an equality expression or the target position of a built-in function.</p> <h2><a name="built-ins"></a> Built-in Functions</h2> <p>In some cases, rules must perform simple arithmetic, aggregation, and so son. Rego provides a number of built-in functions (or “built-ins”) for performing these tasks.</p> <p>Built-ins can be easily recognized by their syntax. All built-ins have the following form:</p> <div class="highlighter-rouge"><pre class="highlight"><code>&lt;name&gt;(&lt;arg-1&gt;, &lt;arg-2&gt;, ..., &lt;arg-n&gt;)
</code></pre> </div> <p>Built-ins usually take one or more input values and produce at least one output value. Unless stated otherwise, all built-ins accept values or variables as output arguments.</p> <h3>Arithmetic</h3> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># plus(a, b, output)</span>
<span class="c1">#</span>
<span class="c1"># Adds two numbers.</span>

<span class="o">&gt;</span> <span class="n">plus</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="n">x</span> <span class="o">|</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="mi">3</span> <span class="o">|</span>
<span class="o">+---+</span>
</code></pre> </div> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># minus(a, b, output)</span>
<span class="c1">#</span>
<span class="c1"># Subtracts two numbers.</span>

<span class="o">&gt;</span> <span class="n">minus</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="n">x</span> <span class="o">|</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="mi">8</span> <span class="o">|</span>
<span class="o">+---+</span>
</code></pre> </div> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># mul(a, b, output)</span>
<span class="c1">#</span>
<span class="c1"># Multiplies two numbers.</span>

<span class="o">&gt;</span> <span class="n">mul</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="n">x</span> <span class="o">|</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="mi">8</span> <span class="o">|</span>
<span class="o">+---+</span>
</code></pre> </div> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># div(a, b, output)</span>
<span class="c1">#</span>
<span class="c1"># Divides two numbers.</span>

<span class="o">&gt;</span> <span class="n">div</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="n">x</span> <span class="o">|</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="mi">4</span> <span class="o">|</span>
<span class="o">+---+</span>
</code></pre> </div> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># round(number, output)</span>
<span class="c1">#</span>
<span class="c1"># Rounds the number to its nearest integer value.</span>

<span class="o">&gt;</span> <span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="n">x</span> <span class="o">|</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="mi">4</span> <span class="o">|</span>
<span class="o">+---+</span>
</code></pre> </div> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># abs(number, output)</span>
<span class="c1">#</span>
<span class="c1"># Calculates the absolute value of a number.</span>

<span class="o">&gt;</span> <span class="n">abs</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="n">x</span> <span class="o">|</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="mi">1</span> <span class="o">|</span>
<span class="o">+---+</span>
</code></pre> </div> <h3>Aggregation</h3> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># count(scalar, output)</span>
<span class="c1">#</span>
<span class="c1"># Counts the number of elements in the array or object or the number of</span>
<span class="c1"># characters in a string.</span>

<span class="o">&gt;</span> <span class="n">count</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="n">x</span> <span class="o">|</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="mi">3</span> <span class="o">|</span>
<span class="o">+---+</span>
</code></pre> </div> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># sum(array, output)</span>
<span class="c1">#</span>
<span class="c1"># Sums the numbers in an array.</span>

<span class="o">&gt;</span> <span class="n">sum</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="n">x</span> <span class="o">|</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="mi">6</span> <span class="o">|</span>
<span class="o">+---+</span>
</code></pre> </div> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># max(array, output)</span>
<span class="c1">#</span>
<span class="c1"># Calculates the maximum value in an array.</span>

<span class="o">&gt;</span> <span class="n">max</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="n">x</span> <span class="o">|</span>
<span class="o">+---+</span>
<span class="o">|</span> <span class="mi">3</span> <span class="o">|</span>
<span class="o">+---+</span>
</code></pre> </div> <h3>Casting</h3> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># to_number(scalar, output)</span>
<span class="c1">#</span>
<span class="c1"># Converts a scalar value to a number.</span>

<span class="o">&gt;</span> <span class="n">to_number</span><span class="p">(</span><span class="s2">"3.14"</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+------+</span>
<span class="o">|</span>  <span class="n">x</span>   <span class="o">|</span>
<span class="o">+------+</span>
<span class="o">|</span> <span class="mi">3</span><span class="o">.</span><span class="mi">14</span> <span class="o">|</span>
<span class="o">+------+</span>
</code></pre> </div> <h3>Regular Expressions</h3> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># re_match(pattern, value)</span>
<span class="c1">#</span>
<span class="c1"># Evaluates to true if value matches regular expression defined by pattern string.</span>

<span class="o">&gt;</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s2">"^us-west-1.*$"</span>
<span class="o">&gt;</span> <span class="n">re_match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="s2">"us-west-1.production"</span><span class="p">)</span>
<span class="kp">true</span>
<span class="o">&gt;</span> <span class="n">re_match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="s2">"us-east-2.dev"</span><span class="p">)</span>
<span class="kp">false</span>
</code></pre> </div> <h3>Strings</h3> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># format_int(number, base, output)</span>
<span class="c1">#</span>
<span class="c1"># Returns the string representation of the number in the given base after converting it to an integer value.</span>

<span class="o">&gt;</span> <span class="n">format_int</span><span class="p">(</span><span class="mi">15</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+-----+</span>
<span class="o">|</span>  <span class="n">x</span>  <span class="o">|</span>
<span class="o">+-----+</span>
<span class="o">|</span> <span class="s2">"f"</span> <span class="o">|</span>
<span class="o">+-----+</span>
</code></pre> </div> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># concat(join, array, output)</span>
<span class="c1">#</span>
<span class="c1"># Returns the string produced by concatenating the elements in array with the join string.</span>
<span class="o">&gt;</span> <span class="n">concat</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="p">[</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bar"</span><span class="p">,</span> <span class="s2">"baz"</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
<span class="o">+----------------+</span>
<span class="o">|</span>       <span class="n">x</span>        <span class="o">|</span>
<span class="o">+----------------+</span>
<span class="o">|</span> <span class="s2">"/foo/bar/baz"</span> <span class="o">|</span>
<span class="o">+----------------+</span>
</code></pre> </div> <h2><a name="examples"></a> Examples</h2> <p>The rules below define the content of documents describing a simplistic deployment environment. These documents are referenced in other sections above.</p> <div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">sites</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">"region"</span><span class="p">:</span> <span class="s2">"east"</span><span class="p">,</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"prod"</span><span class="p">,</span>
        <span class="s2">"servers"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"web-0"</span><span class="p">,</span>
                <span class="s2">"hostname"</span><span class="p">:</span> <span class="s2">"hydrogen"</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"web-1"</span><span class="p">,</span>
                <span class="s2">"hostname"</span><span class="p">:</span> <span class="s2">"helium"</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"db-0"</span><span class="p">,</span>
                <span class="s2">"hostname"</span><span class="p">:</span> <span class="s2">"lithium"</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">"region"</span><span class="p">:</span> <span class="s2">"west"</span><span class="p">,</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"smoke"</span><span class="p">,</span>
        <span class="s2">"servers"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"web-1000"</span><span class="p">,</span>
                <span class="s2">"hostname"</span><span class="p">:</span> <span class="s2">"beryllium"</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"web-1001"</span><span class="p">,</span>
                <span class="s2">"hostname"</span><span class="p">:</span> <span class="s2">"boron"</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"db-1000"</span><span class="p">,</span>
                <span class="s2">"hostname"</span><span class="p">:</span> <span class="s2">"carbon"</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">"region"</span><span class="p">:</span> <span class="s2">"west"</span><span class="p">,</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"dev"</span><span class="p">,</span>
        <span class="s2">"servers"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"web-dev"</span><span class="p">,</span>
                <span class="s2">"hostname"</span><span class="p">:</span> <span class="s2">"nitrogen"</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"db-dev"</span><span class="p">,</span>
                <span class="s2">"hostname"</span><span class="p">:</span> <span class="s2">"oxygen"</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">apps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"web"</span><span class="p">,</span>
        <span class="s2">"servers"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"web-0"</span><span class="p">,</span> <span class="s2">"web-1"</span><span class="p">,</span> <span class="s2">"web-1000"</span><span class="p">,</span> <span class="s2">"web-1001"</span><span class="p">,</span> <span class="s2">"web-dev"</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"mysql"</span><span class="p">,</span>
        <span class="s2">"servers"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"db-0"</span><span class="p">,</span> <span class="s2">"db-1000"</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"mongodb"</span><span class="p">,</span>
        <span class="s2">"servers"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"db-dev"</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">containers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">"image"</span><span class="p">:</span> <span class="s2">"redis"</span><span class="p">,</span>
        <span class="s2">"ipaddress"</span><span class="p">:</span> <span class="s2">"10.0.0.1"</span><span class="p">,</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"big_stallman"</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">"image"</span><span class="p">:</span> <span class="s2">"nginx"</span><span class="p">,</span>
        <span class="s2">"ipaddress"</span><span class="p">:</span> <span class="s2">"10.0.0.2"</span><span class="p">,</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"cranky_euclid"</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre> </div> <h2><a name="grammar"></a> Rego Grammar</h2> <p>Rego’s syntax is defined by the following grammar:</p> <div class="opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code>module         = package { import } policy
package        = "package" ref
import         = "import" package [ "as" var ]
policy         = { rule }
rule           = rule-head [ ":-" rule-body ]
rule-head      = var [ "[" var "]" ] [ = term ]
rule-body      = [ literal { "," literal } ]
literal        = expr | "not" expr
expr           = term | expr-builtin | expr-infix
expr-builtin   = var "(" [ term { , term } ] ")"
expr-infix     = term bool-operator term
term           = ref | var | scalar | array | object | array-compr
array-compr    = "[" term "|" rule-body "]"
bool-operator  = "=" | "!=" | "&lt;" | "&gt;" | "&gt;=" | "&lt;="
ref            = var { ref-arg }
ref-arg        = ref-arg-dot | ref-arg-brack
ref-arg-brack  = "[" ( scalar | var | "_" ) "]"
ref-arg-dot    = "." var
var            = ALPHA { ALPHA | DIGIT | "_" }
scalar         = STRING | NUMBER | TRUE | FALSE | NULL
array          = "[" term { "," term } "]"
object         = "{" object-item { "," object-item } "}"
object-item    = ( scalar | ref | var ) ":" term
</code></pre> </div> <p>The grammar defined above makes use of the following syntax. See <a href="https://en.wikipedia.org/wiki/Extended_Backus–Naur_Form">the Wikipedia page on EBNF</a> for more details:</p> <div class="opa-collapse--ignore highlighter-rouge"><pre class="highlight"><code>[]     optional (zero or one instances)
{}     repetition (zero or more instances)
|      alteration (one of the instances)
()     grouping (order of expansion)
STRING JSON string
NUMBER JSON number
TRUE   JSON true
FALSE  JSON false
NULL   JSON null
ALPHA  ASCII characters A-Z and a-z
DIGIT  ASCII characters 0-9
</code></pre> </div> </div> <footer class="opa-footer"> <p class="opa-footer--text"> <a class="opa-footer--github--link" href="https://github.com/open-policy-agent/opa"><img src="/assets/icon-github.svg" class="opa-footer--github--icon" width="16" height="16" alt="icon-github.svg">open-policy-agent/opa</a> <a href="https://travis-ci.org/open-policy-agent/opa"><img class="opa-footer--github--ci" width="90" height="20" src="https://travis-ci.org/open-policy-agent/opa.svg?branch=master" alt="Build Status"></a> </p> <p class="opa-footer--text"> Join the discussion on Slack (comming soon) or <a class="opa-footer--link" href="https://groups.google.com/forum/?hl=en#!forum/open-policy-agent">Google Groups</a>. Report a bug or request a feature using <a class="opa-footer--link" href="https://github.com/open-policy-agent/opa/issues">GitHub Issues</a>. </p> <p class="opa-footer--text"> © 2016 Open Policy Agent contributors. Licensed under the <a class="opa-footer--link" href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>. For information about contributing, see <a class="opa-footer--link" href="https://github.com/open-policy-agent/opa/blob/master/CONTRIBUTING.md">CONTRIBUTING.md</a>. </p> </footer> <script>var OPA_COLLAPSE_CONFIG={classNames:"highlight",baseClassName:"opa-collapse",collapsedClassName:"opa-collapse--collapsed",ignoreClassName:"opa-collapse--ignore",maxHeight:320,targetClassName:"opa-collapse--target"};</script> <script type="text/javascript" src="/assets/dom.js"></script> <script type="text/javascript" src="/assets/collapse.js"></script> </body> </html>